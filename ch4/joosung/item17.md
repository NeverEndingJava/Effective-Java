# 변경 가능성을 최소화하라

`요약`
- 대부분의 경우 불변 클래스로 만들어야 함
  
  - setter 쓰지 말 것

- 성능 저하로 불변 클래스 구현이 힘들면 가변 동반 클래스를 이용

- 불변 클래스 구현이 불가하면 변경 가능 부분을 최소한으로 줄임

    - 모든 필드는 private final 이어야 함

- 객체의 상태를 초기화 하는 메서드는 생성자, 정적 팩터리 메서드 이외에는 없어야 함

## 불변 클래스

- 클래스의 인스턴스 값을 수정할 수 없는 클래스

- String, Wrapper Class, BigInteger, BigDecimal

### 특징

- 설계, 구현, 사용이 쉬움

- 오류에서 가변 클래스보다 훨씬 안전함

### 구현 방법

- 객체의 상태를 변경하는 메서드를 제공하지 않는다. (예. setter)

- 클래스를 확장할 수 없도록 한다.

    - 하위 클래스에서 객체가 변경될 수 있음

    - 대표적인 방법은 final 키워드
  
- 모든 필드를 final 로 선언한다.

    - 여러 스레드에서 접근해도 값이 바뀌지 않음
  
    - 다중 스레드 환경에서도 안전
  
- 모든 필드를 private 로 선언한다.

- 자신 외에는 내부의 가변 컴포넌트에 접근할 수 없도록 한다.

    - 클래스의 가변 참조 객체 필드에 대한 항목
  
    - 클라이언트에서 이 필드의 참조를 얻으면 안됨
  
    - 서버에서도 접근자 메서드로 이 필드값을 반환하면 안됨
  
    - 생성자, 접근자, readObject 메서드 모두에서 방어적 복사를 수행해야 함


### 불변 객체의 장점
- 단순하다.

    - 생성된 시점의 상태가 파괴될 때까지 간직

- 불변 객체는 근본적으로 스레드 안전하여 따로 동기화 할 필요 없다.

  - Thread-safe 한 클래스를 만드는 가장 쉬운 방법
  
  - 불변 클래스는 한번 만든 인스턴스를 최대한 활용한다. (예. public static final 상)
  
  - 따라서 불변 객체는 안심하고 공유할 수 있음

- 불변 객체는 객체의 필드로 쓰면 좋다.

  - 불변식을 보장할 수 있다음
  
  - Map 의 키나 Set 의 요소로 불변객체를 사용하면 불변식을 지키기 쉬움
  
- 불변 객체는 실패 원자성을 제공한다.
  
  - `실패 원자성` : 메서드 수행 중 예외가 발생해도 객체는 상태를 유지한다.


### 불변 객체의 단점
- 값이 다르면 무조건 독립된 객체를 생성해야 한다.

  - 원하는 객체를 만들기 까지 여러 단계를 거쳐야 한다면, 쓸모없는 객체가 많이 생김
  
  - 위 문제의 해결점으로 다단계 연산을 제하는 **가변 동반 클래스** 를 작성
  
    ```java
    가변 동반 클래스 : 복잡한 다단계 연산을 기본으로 제공 해주는 클래스
    
    BigInteger 에는 package-private 으로 여러 클래스 존재
    String 에는 public 으로 제공되는 StringBuilder, StringBuffer 존재
    ```


### 불변 클래스를 만드는 다른 방법

- 첫, 세번째 규칙. 모든 필드는 final 이고 변경자 메서드가 없다.

    - 어떤 불변 클래스는 계산 비용이 큰 값을 final이 아닌 필드에 캐싱하여 사용함

- 두번째 규칙. 확장할 수 없도록 한다.

    - 모든 생성자를 private, package-private 으로 만들고, 정적 팩터리 메서드 제공함